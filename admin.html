<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 7SIM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { 
            --primary: #4361ee; --secondary: #3f37c9; --success: #4bb543; 
            --danger: #e74c3c; --warning: #f39c12; --sidebar: #2c3e50; 
        }
        
        body { display: flex; background: #f8f9fa; min-height: 100vh; }
        
        /* 侧边栏 */
        .sidebar {
            width: 250px; background: var(--sidebar); color: white; 
            height: 100vh; position: fixed; left: 0; top: 0; padding: 20px 0;
        }
        
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid #34495e; margin-bottom: 20px; }
        .sidebar-header h2 { font-size: 1.2rem; }
        .sidebar-header .admin-name { color: #bdc3c7; font-size: 0.9rem; }
        
        .nav-item {
            padding: 15px 20px; cursor: pointer; transition: background 0.3s;
            border-left: 3px solid transparent; display: flex; align-items: center;
        }
        .nav-item:hover { background: #34495e; }
        .nav-item.active { background: #34495e; border-left-color: var(--primary); }
        .nav-item i { width: 20px; margin-right: 10px; }
        
        /* 主内容区 */
        .main-content {
            margin-left: 250px; padding: 30px; width: calc(100% - 250px);
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        /* 内容卡片 */
        .content-card {
            background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none;
        }
        .content-card.active { display: block; }
        
        /* 表格样式 */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background: #f8f9fa; font-weight: 600; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .crypto-method { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .action-buttons { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        
        /* 统计卡片 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: #6c757d; }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        /* 用户详情卡片 */
        .user-detail-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .user-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .user-detail-label {
            font-weight: 600;
            color: #495057;
        }
        
        .user-detail-value {
            color: #212529;
        }
        
        .api-key-display {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            word-break: break-all;
        }
        
        /* 转账信息卡片 */
        .transfer-info-card {
            background: #e8f5e8;
            border: 1px solid #4bb543;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .token-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>7SIM 管理后台</h2>
            <div class="admin-name" id="currentAdmin">管理员</div>
        </div>
        <div class="nav-item" data-tab="pricing">
    <i class="fas fa-tags"></i> 价格设置
</div>
        <div class="nav-item active" data-tab="products">
            <i class="fas fa-box"></i> 产品设置
        </div>
        <div class="nav-item" data-tab="users">
            <i class="fas fa-users"></i> 用户列表
        </div>
        <div class="nav-item" data-tab="crypto">
            <i class="fas fa-coins"></i> 加密货币转账
        </div>
        <div class="nav-item" data-tab="wallet">
            <i class="fas fa-wallet"></i> 钱包设置
        </div>
        <div class="nav-item" onclick="adminLogout()" style="margin-top: 20px; border-top: 1px solid #34495e; padding-top: 20px;">
            <i class="fas fa-sign-out-alt"></i> 退出登录
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <div class="header">
            <h1 id="pageTitle">产品设置</h1>
            <div>欢迎, <span id="adminWelcome"></span> | <span id="currentTime"></span></div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">总用户数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalServices">0</div>
                <div class="stat-label">服务数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">¥0</div>
                <div class="stat-label">总收入</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeServices">0</div>
                <div class="stat-label">活跃服务</div>
            </div>
        </div>

        <!-- 产品设置 -->
        <div class="content-card active" id="products">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-cog"></i> 接码服务管理</h3>
                <button class="btn btn-primary" onclick="showAddServiceModal()">
                    <i class="fas fa-plus"></i> 添加服务
                </button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>类型</th>
                        <th>价格 (¥)</th>
                        <th>库存</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="servicesTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 用户列表 -->
        <div class="content-card" id="users">
            <h3><i class="fas fa-users"></i> 用户管理</h3>
            <table>
                <thead>
                    <tr>
                        <th>用户ID</th>
                        <th>邮箱</th>
                        <th>API Key</th>
                        <th>余额</th>
                        <th>注册时间</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 价格设置 -->
<div class="content-card" id="pricing">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3><i class="fas fa-tags"></i> 应用-国家价格设置</h3>
        <button class="btn btn-primary" onclick="showAddPriceModal()">
            <i class="fas fa-plus"></i> 添加价格规则
        </button>
    </div>
    
    <div class="search-controls" style="display: flex; gap: 15px; margin-bottom: 20px;">
        <div class="form-group" style="flex: 1;">
            <label>筛选应用</label>
            <select class="form-control" id="filterService" onchange="filterPricingTable()">
                <option value="">所有应用</option>
            </select>
        </div>
        <div class="form-group" style="flex: 1;">
            <label>筛选国家</label>
            <select class="form-control" id="filterCountry" onchange="filterPricingTable()">
                <option value="">所有国家</option>
            </select>
        </div>
    </div>
    
    <table>
        <thead>
            <tr>
                <th>应用</th>
                <th>国家</th>
                <th>价格 ($)</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="pricingTable">
            <!-- 动态加载 -->
        </tbody>
    </table>
</div>
        
        <!-- 加密货币转账 -->
        <div class="content-card" id="crypto">
            <h3><i class="fas fa-exchange-alt"></i> 加密货币转账</h3>
            
            <div class="form-group">
                <label>选择用户</label>
                <select class="form-control" id="transferUser" onchange="loadUserCryptoInfo()">
                    <option value="">选择用户...</option>
                </select>
            </div>
            
            <!-- 用户加密货币信息 -->
            <div id="userCryptoInfo" style="display: none;">
                <div class="user-detail-card">
                    <h4>用户钱包信息</h4>
                    <div class="user-detail-row">
                        <span class="user-detail-label">用户ID:</span>
                        <span class="user-detail-value" id="cryptoUserId">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">钱包地址:</span>
                        <span class="user-detail-value" id="cryptoWalletAddress">-</span>
                    </div>
                    <div class="user-detail-row">
                        <span class="user-detail-label">授权网络:</span>
                        <span class="user-detail-value" id="cryptoNetwork">-</span>
                    </div>
                </div>
                
                <div class="transfer-info-card">
                    <h4>代币余额</h4>
                    <div class="token-balance">
                        <span>USDT 余额:</span>
                        <strong id="usdtBalance">0.00</strong>
                    </div>
                    <div class="token-balance">
                        <span>USDC 余额:</span>
                        <strong id="usdcBalance">0.00</strong>
                    </div>
                    <div class="token-balance">
                        <span>授权金额:</span>
                        <strong id="approvedAmount">0.00</strong>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>转账金额 (USDT/USDC)</label>
                    <input type="number" class="form-control" id="transferAmount" placeholder="输入转账金额" step="0.01">
                </div>
                
                <div class="form-group">
                    <label>选择代币</label>
                    <select class="form-control" id="transferToken">
                        <option value="usdt">USDT</option>
                        <option value="usdc">USDC</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>选择网络</label>
                    <select class="form-control" id="transferNetwork">
                        <option value="trc20">TRC20</option>
                        <option value="erc20">ERC20</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>收款地址</label>
                    <input type="text" class="form-control" id="transferToAddress" placeholder="输入收款钱包地址">
                </div>
                
                <button class="btn btn-primary" onclick="processCryptoTransfer()">
                    <i class="fas fa-paper-plane"></i> 执行转账 (调用 transferFrom)
                </button>
                
                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <h4>转账记录</h4>
                    <div id="transferHistory">
                        <div style="padding: 10px; background: white; margin: 5px 0; border-radius: 3px; font-size: 0.9rem;">
                            暂无转账记录
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 钱包设置 -->
        <div class="content-card" id="wallet">
            <h3><i class="fas fa-wallet"></i> 支付方式配置</h3>
            
            <div class="crypto-method">
                <h4>TRC20 USDT</h4>
                <div class="form-group">
                    <label>收款地址</label>
                    <input type="text" class="form-control" id="trc20Address" placeholder="TRC20 USDT 收款地址">
                </div>
                <div class="form-group">
                    <label>网络</label>
                    <input type="text" class="form-control" value="TRC20" readonly>
                </div>
            </div>
            
            <div class="crypto-method">
                <h4>ERC20 USDT</h4>
                <div class="form-group">
                    <label>收款地址</label>
                    <input type="text" class="form-control" id="erc20usdtAddress" placeholder="ERC20 USDT 收款地址">
                </div>
                <div class="form-group">
                    <label>网络</label>
                    <input type="text" class="form-control" value="ERC20" readonly>
                </div>
            </div>
            
            <div class="crypto-method">
                <h4>ERC20 USDC</h4>
                <div class="form-group">
                    <label>收款地址</label>
                    <input type="text" class="form-control" id="erc20usdcAddress" placeholder="ERC20 USDC 收款地址">
                </div>
                <div class="form-group">
                    <label>网络</label>
                    <input type="text" class="form-control" value="ERC20" readonly>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="savePaymentConfig()">保存支付配置</button>
        </div>
    </div>

    <!-- 添加服务模态框 -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加接码服务</h3>
                <button class="close-modal" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addServiceForm">
                    <div class="form-group">
                        <label>服务名称</label>
                        <input type="text" class="form-control" id="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>服务类型</label>
                        <select class="form-control" id="serviceType" required>
                            <option value="country">国家</option>
                            <option value="app">应用</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>价格 (¥)</label>
                            <input type="number" class="form-control" id="servicePrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label>库存数量</label>
                            <input type="number" class="form-control" id="serviceStock" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label id="iconLabel">国旗URL</label>
                        <input type="text" class="form-control" id="serviceIcon" placeholder="输入国旗图片URL或图标类名">
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="text-align: right;">
                <button class="btn" onclick="closeModal('addServiceModal')">取消</button>
                <button class="btn btn-primary" onclick="addService()">添加服务</button>
            </div>
        </div>
    </div>

    <!-- 添加价格规则模态框 -->
<div class="modal" id="addPriceModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="priceModalTitle">添加价格规则</h3>
            <button class="close-modal" onclick="closeModal('addPriceModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="addPriceForm">
                <div class="form-group">
                    <label>选择应用</label>
                    <select class="form-control" id="priceService" required>
                        <option value="">选择应用...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>选择国家</label>
                    <select class="form-control" id="priceCountry" required>
                        <option value="">选择国家...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>价格 ($)</label>
                    <input type="number" class="form-control" id="priceAmount" step="0.01" min="0.01" required>
                </div>
                <div class="form-group">
                    <label>状态</label>
                    <select class="form-control" id="priceStatus">
                        <option value="active">启用</option>
                        <option value="inactive">禁用</option>
                    </select>
                </div>
    <input type="hidden" id="priceModalAction" value="add">
    <input type="hidden" id="priceRuleId" value="">
</form>
            </form>
        </div>
        <div class="modal-footer" style="text-align: right;">
            <button class="btn" onclick="closeModal('addPriceModal')">取消</button>
            <button class="btn btn-primary" onclick="savePriceRule()">保存价格规则</button>
        </div>
    </div>
</div>

    <!-- 用户详情模态框 -->
    <div class="modal" id="userDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>用户详细信息</h3>
                <button class="close-modal" onclick="closeModal('userDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="userDetailContent">
                    <!-- 动态加载用户详情 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 检查管理员登录状态
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // 显示当前管理员
        const currentAdmin = sessionStorage.getItem('adminUsername') || '管理员';
        document.getElementById('currentAdmin').textContent = currentAdmin;
        document.getElementById('adminWelcome').textContent = currentAdmin;

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyAKcWEdi_Zd-CAJYtEiwkbNNs7ibOp6HG4",
            authDomain: "sim-platform-fa8dd.firebaseapp.com",
            projectId: "sim-platform-fa8dd",
            storageBucket: "sim-platform-fa8dd.firebasestorage.app",
            messagingSenderId: "276606433877",
            appId: "1:276606433877:web:ac217c829ffdc735fff2dc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let appData = {
    services: [],
    paymentMethods: [],
    users: []
};

// 初始化默认国家数据
function initDefaultCountries() {
    const defaultCountries = [
        { id: 1, name: "中国", type: "country", price: 0.10, stock: 200000, active: true, flag: "https://flagcdn.com/w40/cn.png" },
        { id: 2, name: "美国", type: "country", price: 0.15, stock: 150000, active: true, flag: "https://flagcdn.com/w40/us.png" },
        { id: 3, name: "英国", type: "country", price: 0.12, stock: 120000, active: true, flag: "https://flagcdn.com/w40/gb.png" },
        { id: 4, name: "加拿大", type: "country", price: 0.13, stock: 80000, active: true, flag: "https://flagcdn.com/w40/ca.png" },
        { id: 5, name: "澳大利亚", type: "country", price: 0.14, stock: 70000, active: true, flag: "https://flagcdn.com/w40/au.png" },
        { id: 6, name: "德国", type: "country", price: 0.11, stock: 90000, active: true, flag: "https://flagcdn.com/w40/de.png" },
        { id: 7, name: "法国", type: "country", price: 0.11, stock: 85000, active: true, flag: "https://flagcdn.com/w40/fr.png" },
        { id: 8, name: "俄罗斯", type: "country", price: 0.08, stock: 100000, active: true, flag: "https://flagcdn.com/w40/ru.png" },
        { id: 9, name: "日本", type: "country", price: 0.16, stock: 75000, active: true, flag: "https://flagcdn.com/w40/jp.png" },
        { id: 10, name: "韩国", type: "country", price: 0.15, stock: 65000, active: true, flag: "https://flagcdn.com/w40/kr.png" },
        { id: 11, name: "印度", type: "country", price: 0.05, stock: 180000, active: true, flag: "https://flagcdn.com/w40/in.png" },
        { id: 12, name: "印度尼西亚", type: "country", price: 0.06, stock: 95000, active: true, flag: "https://flagcdn.com/w40/id.png" },
        { id: 13, name: "马来西亚", type: "country", price: 0.07, stock: 60000, active: true, flag: "https://flagcdn.com/w40/my.png" },
        { id: 14, name: "泰国", type: "country", price: 0.06, stock: 55000, active: true, flag: "https://flagcdn.com/w40/th.png" },
        { id: 15, name: "越南", type: "country", price: 0.05, stock: 50000, active: true, flag: "https://flagcdn.com/w40/vn.png" },
        { id: 16, name: "菲律宾", type: "country", price: 0.05, stock: 45000, active: true, flag: "https://flagcdn.com/w40/ph.png" },
        { id: 17, name: "巴西", type: "country", price: 0.09, stock: 85000, active: true, flag: "https://flagcdn.com/w40/br.png" },
        { id: 18, name: "墨西哥", type: "country", price: 0.08, stock: 40000, active: true, flag: "https://flagcdn.com/w40/mx.png" },
        { id: 19, name: "阿根廷", type: "country", price: 0.07, stock: 35000, active: true, flag: "https://flagcdn.com/w40/ar.png" },
        { id: 20, name: "土耳其", type: "country", price: 0.08, stock: 45000, active: true, flag: "https://flagcdn.com/w40/tr.png" },
        { id: 21, name: "沙特阿拉伯", type: "country", price: 0.10, stock: 30000, active: true, flag: "https://flagcdn.com/w40/sa.png" },
        { id: 22, name: "阿联酋", type: "country", price: 0.12, stock: 25000, active: true, flag: "https://flagcdn.com/w40/ae.png" },
        { id: 23, name: "南非", type: "country", price: 0.07, stock: 20000, active: true, flag: "https://flagcdn.com/w40/za.png" },
        { id: 24, name: "埃及", type: "country", price: 0.06, stock: 25000, active: true, flag: "https://flagcdn.com/w40/eg.png" },
        { id: 25, name: "尼日利亚", type: "country", price: 0.05, stock: 30000, active: true, flag: "https://flagcdn.com/w40/ng.png" },
        { id: 26, name: "乌克兰", type: "country", price: 0.07, stock: 40000, active: true, flag: "https://flagcdn.com/w40/ua.png" },
        { id: 27, name: "波兰", type: "country", price: 0.09, stock: 35000, active: true, flag: "https://flagcdn.com/w40/pl.png" },
        { id: 28, name: "意大利", type: "country", price: 0.10, stock: 45000, active: true, flag: "https://flagcdn.com/w40/it.png" },
        { id: 29, name: "西班牙", type: "country", price: 0.10, stock: 50000, active: true, flag: "https://flagcdn.com/w40/es.png" },
        { id: 30, name: "荷兰", type: "country", price: 0.11, stock: 30000, active: true, flag: "https://flagcdn.com/w40/nl.png" }
    ];
    
    // 检查是否已经有国家数据，如果没有就添加默认国家
    const hasCountries = appData.services.some(service => service.type === 'country');
    if (!hasCountries) {
        appData.services = [...appData.services, ...defaultCountries];
        saveAppData();
    }
}

        // 退出登录
        function adminLogout() {
            sessionStorage.clear();
            window.location.href = 'admin-login.html';
        }

        // 更新时间
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // 侧边栏切换
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                if (this.dataset.tab) {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.content-card').forEach(card => card.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    document.getElementById('pageTitle').textContent = this.textContent.trim();
                    
                    loadTabData(this.dataset.tab);
                }
            });
        });

        // 加载数据
        async function loadAppData() {
            try {
                // 从localStorage加载或使用默认数据
                const savedData = localStorage.getItem('appData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                }
                return appData;
            } catch (error) {
                console.error('加载数据失败:', error);
                return { services: [], paymentMethods: [], users: [] };
            }
        }

        // 保存数据
        function saveAppData() {
            localStorage.setItem('appData', JSON.stringify(appData));
            console.log('数据已保存到本地存储');
        }

        // 价格管理数据
let pricingRules = [];

// 初始化价格数据
function initPricingData() {
    const savedPricing = localStorage.getItem('pricingRules');
    if (savedPricing) {
        pricingRules = JSON.parse(savedPricing);
    }
}

// 保存价格数据
function savePricingData() {
    localStorage.setItem('pricingRules', JSON.stringify(pricingRules));
}

// 加载价格设置页面
function loadPricingPage() {
    loadServicesForPricing();
    loadCountriesForPricing();
    loadPricingTable();
}

// 为价格设置加载服务列表
function loadServicesForPricing() {
    const serviceSelect = document.getElementById('priceService');
    const filterService = document.getElementById('filterService');
    
    serviceSelect.innerHTML = '<option value="">选择应用...</option>';
    filterService.innerHTML = '<option value="">所有应用</option>';
    
    appData.services.filter(service => service.type === 'app').forEach(service => {
        serviceSelect.innerHTML += `<option value="${service.id}">${service.name}</option>`;
        filterService.innerHTML += `<option value="${service.id}">${service.name}</option>`;
    });
}

// 为价格设置加载国家列表
function loadCountriesForPricing() {
    const countrySelect = document.getElementById('priceCountry');
    const filterCountry = document.getElementById('filterCountry');
    
    countrySelect.innerHTML = '<option value="">选择国家...</option>';
    filterCountry.innerHTML = '<option value="">所有国家</option>';
    
    appData.services.filter(service => service.type === 'country').forEach(country => {
        countrySelect.innerHTML += `<option value="${country.id}">${country.name}</option>`;
        filterCountry.innerHTML += `<option value="${country.id}">${country.name}</option>`;
    });
}

// 加载价格表格
function loadPricingTable() {
    const tbody = document.getElementById('pricingTable');
    tbody.innerHTML = '';
    
    const filterService = document.getElementById('filterService').value;
    const filterCountry = document.getElementById('filterCountry').value;
    
    let filteredRules = pricingRules;
    
    if (filterService) {
        filteredRules = filteredRules.filter(rule => rule.serviceId == filterService);
    }
    
    if (filterCountry) {
        filteredRules = filteredRules.filter(rule => rule.countryId == filterCountry);
    }
    
    filteredRules.forEach(rule => {
        const service = appData.services.find(s => s.id == rule.serviceId);
        const country = appData.services.find(s => s.id == rule.countryId);
        
        if (service && country) {
            tbody.innerHTML += `
                <tr>
                    <td>${service.name}</td>
                    <td>${country.name}</td>
                    <td>$${rule.price.toFixed(2)}</td>
                    <td>${rule.active ? '启用' : '禁用'}</td>
                    <td>${new Date(rule.createdAt).toLocaleDateString()}</td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editPriceRule(${rule.id})">编辑</button>
                        <button class="btn btn-sm btn-danger" onclick="deletePriceRule(${rule.id})">删除</button>
                    </td>
                </tr>
            `;
        }
    });
    
    if (filteredRules.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;">
                    暂无价格规则，请点击"添加价格规则"按钮创建
                </td>
            </tr>
        `;
    }
}

// 筛选价格表格
function filterPricingTable() {
    loadPricingTable();
}

// 显示添加价格模态框
function showAddPriceModal() {
    document.getElementById('priceModalTitle').textContent = '添加价格规则';
    document.getElementById('addPriceForm').reset();
    document.getElementById('priceModalAction').value = 'add';
    document.getElementById('priceRuleId').value = '';
    document.getElementById('addPriceModal').style.display = 'flex';
}

// 编辑价格规则
function editPriceRule(ruleId) {
    const rule = pricingRules.find(r => r.id == ruleId);
    if (rule) {
        document.getElementById('priceModalTitle').textContent = '编辑价格规则';
        document.getElementById('priceService').value = rule.serviceId;
        document.getElementById('priceCountry').value = rule.countryId;
        document.getElementById('priceAmount').value = rule.price;
        document.getElementById('priceStatus').value = rule.active ? 'active' : 'inactive';
        document.getElementById('priceModalAction').value = 'edit';
        document.getElementById('priceRuleId').value = rule.id;
        document.getElementById('addPriceModal').style.display = 'flex';
    }
}

// 保存价格规则
function savePriceRule() {
    const serviceId = document.getElementById('priceService').value;
    const countryId = document.getElementById('priceCountry').value;
    const price = parseFloat(document.getElementById('priceAmount').value);
    const active = document.getElementById('priceStatus').value === 'active';
    const action = document.getElementById('priceModalAction').value;
    const ruleId = document.getElementById('priceRuleId').value;
    
    if (!serviceId || !countryId || !price) {
        alert('请填写完整信息');
        return;
    }
    
    // 检查是否已存在相同的应用-国家组合
    const existingRule = pricingRules.find(rule => 
        rule.serviceId == serviceId && rule.countryId == countryId && rule.id != ruleId
    );
    
    if (existingRule) {
        alert('该应用-国家组合的价格规则已存在，请编辑现有规则');
        return;
    }
    
    if (action === 'add') {
        const newRule = {
            id: Date.now(),
            serviceId: parseInt(serviceId),
            countryId: parseInt(countryId),
            price: price,
            active: active,
            createdAt: new Date().toISOString()
        };
        pricingRules.push(newRule);
    } else {
        const ruleIndex = pricingRules.findIndex(rule => rule.id == ruleId);
        if (ruleIndex !== -1) {
            pricingRules[ruleIndex] = {
                ...pricingRules[ruleIndex],
                serviceId: parseInt(serviceId),
                countryId: parseInt(countryId),
                price: price,
                active: active
            };
        }
    }
    
    savePricingData();
    loadPricingTable();
    closeModal('addPriceModal');
    alert('价格规则保存成功！');
}
        // 通知 dashboard 页面价格规则已更新
    notifyDashboardPriceUpdate();
    
    alert('价格规则保存成功！');
}

// 通知 dashboard 价格更新
function notifyDashboardPriceUpdate() {
    // 触发 storage 事件
    const updateEvent = new Event('storage');
    window.localStorage.setItem('pricingRulesUpdate', Date.now().toString());
    setTimeout(() => {
        window.localStorage.removeItem('pricingRulesUpdate');
    }, 100);
}

// 删除价格规则
function deletePriceRule(ruleId) {
    if (confirm('确定要删除这个价格规则吗？')) {
        pricingRules = pricingRules.filter(rule => rule.id != ruleId);
        savePricingData();
        loadPricingTable();
        alert('价格规则已删除！');
    }
}

       // 加载标签页数据
async function loadTabData(tab) {
    await loadAppData();
    
    switch(tab) {
        case 'products':
            loadServices();
            break;
        case 'pricing':
            loadPricingPage();
            break;
        case 'users':
            loadUsers();
            break;
        case 'crypto':
            loadTransferUsers();
            break;
        case 'wallet':
            loadWalletConfig();
            break;
    }
    updateStats();
}

        // 加载服务列表
        function loadServices() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = '';
            
            appData.services.forEach(service => {
                tbody.innerHTML += `
                    <tr>
                        <td>${service.name}</td>
                        <td>${service.type === 'country' ? '国家' : '应用'}</td>
                        <td>¥${service.price}</td>
                        <td>${service.stock}</td>
                        <td>${service.active ? '启用' : '禁用'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="editService(${service.id})">编辑</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${service.id})">删除</button>
                        </td>
                    </tr>
                `;
            });
        }

        // 加载用户列表
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            
            // 从Firebase加载真实用户数据
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                const user = doc.data();
                const apiKey = user.apiKey || '未生成';
                const shortApiKey = apiKey.length > 20 ? apiKey.substring(0, 20) + '...' : apiKey;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${doc.id.substring(0, 8)}...</td>
                        <td>${user.email}</td>
                        <td title="${apiKey}">${shortApiKey}</td>
                        <td>¥${user.balance || 0}</td>
                        <td>${user.createdAt?.toDate?.().toLocaleDateString() || '未知'}</td>
                        <td>${user.lastLogin?.toDate?.().toLocaleDateString() || '未知'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showUserDetail('${doc.id}')">详情</button>
                            <button class="btn btn-sm btn-warning" onclick="editUserBalance('${doc.id}')">调整余额</button>
                        </td>
                    </tr>
                `;
            });
        }

        // 显示用户详情
        async function showUserDetail(userId) {
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) {
                const user = doc.data();
                const content = document.getElementById('userDetailContent');
                
                content.innerHTML = `
                    <div class="user-detail-card">
                        <div class="user-detail-row">
                            <span class="user-detail-label">用户ID:</span>
                            <span class="user-detail-value">${userId}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">邮箱:</span>
                            <span class="user-detail-value">${user.email}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">API Key:</span>
                            <span class="user-detail-value">
                                <div class="api-key-display">${user.apiKey || '未生成'}</div>
                            </span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">余额:</span>
                            <span class="user-detail-value">¥${user.balance || 0}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">注册时间:</span>
                            <span class="user-detail-value">${user.createdAt?.toDate?.().toLocaleString() || '未知'}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">最后登录:</span>
                            <span class="user-detail-value">${user.lastLogin?.toDate?.().toLocaleString() || '未知'}</span>
                        </div>
                        <div class="user-detail-row">
                            <span class="user-detail-label">加密货币钱包:</span>
                            <span class="user-detail-value">${user.cryptoWallet || '未绑定'}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('userDetailModal').style.display = 'flex';
            }
        }

        // 加载钱包配置
        function loadWalletConfig() {
            const paymentMethod = appData.paymentMethods.find(m => m.name === 'TRC20 USDT');
            if (paymentMethod) {
                document.getElementById('trc20Address').value = paymentMethod.address;
            }
            
            const erc20usdt = appData.paymentMethods.find(m => m.name === 'ERC20 USDT');
            if (erc20usdt) {
                document.getElementById('erc20usdtAddress').value = erc20usdt.address;
            }
            
            const erc20usdc = appData.paymentMethods.find(m => m.name === 'ERC20 USDC');
            if (erc20usdc) {
                document.getElementById('erc20usdcAddress').value = erc20usdc.address;
            }
        }

        // 加载转账用户列表
        async function loadTransferUsers() {
            const select = document.getElementById('transferUser');
            select.innerHTML = '<option value="">选择用户...</option>';
            
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                const user = doc.data();
                select.innerHTML += `<option value="${doc.id}">${user.email} (余额: ¥${user.balance || 0})</option>`;
            });
        }

        // 加载用户加密货币信息
        async function loadUserCryptoInfo() {
            const userId = document.getElementById('transferUser').value;
            if (!userId) {
                document.getElementById('userCryptoInfo').style.display = 'none';
                return;
            }
            
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) {
                const user = doc.data();
                
                // 显示用户加密货币信息
                document.getElementById('cryptoUserId').textContent = userId.substring(0, 12) + '...';
                document.getElementById('cryptoWalletAddress').textContent = user.cryptoWallet || '未绑定钱包';
                document.getElementById('cryptoNetwork').textContent = user.cryptoNetwork || '未知';
                
                // 模拟代币余额（实际应该从区块链获取）
                document.getElementById('usdtBalance').textContent = '150.75';
                document.getElementById('usdcBalance').textContent = '89.20';
                document.getElementById('approvedAmount').textContent = '500.00';
                
                document.getElementById('userCryptoInfo').style.display = 'block';
            }
        }

        // 更新统计信息
        function updateStats() {
            document.getElementById('totalServices').textContent = appData.services.length;
            document.getElementById('activeServices').textContent = appData.services.filter(s => s.active).length;
            
            // 从Firebase获取用户统计
            db.collection('users').get().then(snapshot => {
                document.getElementById('totalUsers').textContent = snapshot.size;
            });
        }
        // 删除服务
function deleteService(serviceId) {
    if (confirm('确定要删除这个服务吗？此操作不可恢复！')) {
        // 从服务列表中移除
        appData.services = appData.services.filter(service => service.id !== serviceId);
        
        // 同时删除相关的价格规则
        pricingRules = pricingRules.filter(rule => 
            rule.serviceId !== serviceId && rule.countryId !== serviceId
        );
        
        saveAppData();
        savePricingData();
        loadServices();
        alert('服务删除成功！');
    }
}

// 编辑服务（占位函数，需要您后续实现）
function editService(serviceId) {
    const service = appData.services.find(s => s.id === serviceId);
    if (service) {
        // 填充模态框数据
        document.getElementById('serviceName').value = service.name;
        document.getElementById('serviceType').value = service.type;
        document.getElementById('servicePrice').value = service.price;
        document.getElementById('serviceStock').value = service.stock;
        document.getElementById('serviceIcon').value = service.icon || service.flag || '';
        
        // 显示编辑模态框
        document.getElementById('addServiceModal').style.display = 'flex';
        
        // 这里可以添加编辑模式的逻辑
        alert('编辑功能开发中...');
    }
}
        // 模态框功能
        function showAddServiceModal() {
            document.getElementById('addServiceModal').style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function addService() {
            const name = document.getElementById('serviceName').value;
            const type = document.getElementById('serviceType').value;
            const price = parseFloat(document.getElementById('servicePrice').value);
            const stock = parseInt(document.getElementById('serviceStock').value);
            const icon = document.getElementById('serviceIcon').value;
            
            const newService = {
                id: Date.now(),
                name,
                type,
                price,
                stock,
                active: true,
                [type === 'country' ? 'flag' : 'icon']: icon || (type === 'country' ? 'https://flagcdn.com/w80/us.png' : 'fas fa-mobile-alt')
            };
            
            appData.services.push(newService);
            saveAppData();
            loadServices();
            closeModal('addServiceModal');
            alert('服务添加成功！');
        }

        // 保存支付配置
        function savePaymentConfig() {
            appData.paymentMethods = [
                {
                    name: 'TRC20 USDT',
                    address: document.getElementById('trc20Address').value,
                    active: true
                },
                {
                    name: 'ERC20 USDT',
                    address: document.getElementById('erc20usdtAddress').value,
                    active: true
                },
                {
                    name: 'ERC20 USDC', 
                    address: document.getElementById('erc20usdcAddress').value,
                    active: true
                }
            ];
            
            saveAppData();
            alert('支付配置已保存！');
        }

        // 加密货币转账 - 准备调用智能合约
        function processCryptoTransfer() {
            const userId = document.getElementById('transferUser').value;
            const amount = document.getElementById('transferAmount').value;
            const token = document.getElementById('transferToken').value;
            const network = document.getElementById('transferNetwork').value;
            const toAddress = document.getElementById('transferToAddress').value;
            
            if (!userId || !amount || !toAddress) {
                alert('请填写完整信息');
                return;
            }
            
            // 这里准备调用智能合约的 transferFrom 函数
            console.log('准备调用智能合约:');
            console.log('用户ID:', userId);
            console.log('代币:', token.toUpperCase());
            console.log('网络:', network.toUpperCase());
            console.log('金额:', amount);
            console.log('收款地址:', toAddress);
            
            // 模拟转账记录
            const history = document.getElementById('transferHistory');
            const timestamp = new Date().toLocaleString('zh-CN');
            history.innerHTML = `
                <div style="padding: 10px; background: white; margin: 5px 0; border-radius: 3px; font-size: 0.9rem;">
                    <strong>${timestamp}</strong><br>
                    转账 ${amount} ${token.toUpperCase()} 到 ${toAddress} (${network.toUpperCase()})<br>
                    <small style="color: var(--success);">状态: 等待调用合约</small>
                </div>
            ` + history.innerHTML;
            
            alert(`准备执行转账!\n\n将调用 transferFrom 函数:\n代币: ${token.toUpperCase()}\n金额: ${amount}\n收款地址: ${toAddress}\n网络: ${network.toUpperCase()}`);
            
            // 清空表单
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferToAddress').value = '';
        }

        // 初始化价格数据
initPricingData();

        // 初始化默认国家数据
initDefaultCountries();

        // 初始化加载产品数据
        loadTabData('products');

        // 服务类型切换时更新标签
        document.getElementById('serviceType').addEventListener('change', function() {
            const label = document.getElementById('iconLabel');
            label.textContent = this.value === 'country' ? '国旗URL' : '图标类名';
        });
    </script>
</body>
</html>
