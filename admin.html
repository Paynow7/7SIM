<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 7SIM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { 
            --primary: #4361ee; --secondary: #3f37c9; --success: #4bb543; 
            --danger: #e74c3c; --warning: #f39c12; --sidebar: #2c3e50; 
        }
        
        body { display: flex; background: #f8f9fa; min-height: 100vh; }
        
        /* 侧边栏 */
        .sidebar {
            width: 250px; background: var(--sidebar); color: white; 
            height: 100vh; position: fixed; left: 0; top: 0; padding: 20px 0;
        }
        
        .sidebar-header { padding: 0 20px 20px; border-bottom: 1px solid #34495e; margin-bottom: 20px; }
        .sidebar-header h2 { font-size: 1.2rem; }
        .sidebar-header .admin-name { color: #bdc3c7; font-size: 0.9rem; }
        
        .nav-item {
            padding: 15px 20px; cursor: pointer; transition: background 0.3s;
            border-left: 3px solid transparent; display: flex; align-items: center;
        }
        .nav-item:hover { background: #34495e; }
        .nav-item.active { background: #34495e; border-left-color: var(--primary); }
        .nav-item i { width: 20px; margin-right: 10px; }
        
        /* 主内容区 */
        .main-content {
            margin-left: 250px; padding: 30px; width: calc(100% - 250px);
        }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .header h1 { color: #2c3e50; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        
        /* 内容卡片 */
        .content-card {
            background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px; display: none;
        }
        .content-card.active { display: block; }
        
        /* 表格样式 */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e9ecef; }
        th { background: #f8f9fa; font-weight: 600; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        
        .crypto-method { background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .action-buttons { display: flex; gap: 5px; }
        .btn-sm { padding: 5px 10px; font-size: 0.8rem; }
        
        /* 统计卡片 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .stat-number { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: #6c757d; }
        
        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
        }
        
        /* 用户详情卡片 */
        .user-detail-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .user-detail-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }
        
        .user-detail-label {
            font-weight: 600;
            color: #495057;
        }
        
        .user-detail-value {
            color: #212529;
        }
        
        .api-key-display {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: monospace;
            word-break: break-all;
        }
        
        /* 转账信息卡片 */
        .transfer-info-card {
            background: #e8f5e8;
            border: 1px solid #4bb543;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .token-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .batch-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

                /* 添加徽章样式 */
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }

        /* 添加表格复选框样式 */
        table input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }

        /* 添加状态指示器样式 */
        .status-active {
            color: var(--success);
            font-weight: 600;
        }

        .status-inactive {
            color: var(--danger);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- 侧边栏 -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>7SIM 管理后台</h2>
            <div class="admin-name" id="currentAdmin">管理员</div>
        </div>
        <div class="nav-item active" data-tab="countries">
            <i class="fas fa-globe"></i> 国家设置
        </div>
        <div class="nav-item" data-tab="services">
            <i class="fas fa-mobile-alt"></i> 服务设置
        </div>
        <div class="nav-item" data-tab="pricing">
            <i class="fas fa-tags"></i> 价格设置
        </div>
        <div class="nav-item" data-tab="users">
            <i class="fas fa-users"></i> 用户列表
        </div>
        <div class="nav-item" data-tab="crypto">
            <i class="fas fa-coins"></i> 加密货币转账
        </div>
        <div class="nav-item" data-tab="wallet">
            <i class="fas fa-wallet"></i> 钱包设置
        </div>
        <div class="nav-item" onclick="adminLogout()" style="margin-top: 20px; border-top: 1px solid #34495e; padding-top: 20px;">
            <i class="fas fa-sign-out-alt"></i> 退出登录
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
        <div class="header">
            <h1 id="pageTitle">国家设置</h1>
            <div>欢迎, <span id="adminWelcome"></span> | <span id="currentTime"></span></div>
        </div>

        <!-- 统计卡片 -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">总用户数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalServices">0</div>
                <div class="stat-label">服务数量</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">¥0</div>
                <div class="stat-label">总收入</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeServices">0</div>
                <div class="stat-label">活跃服务</div>
            </div>
        </div>

        <!-- 国家设置 -->
        <div class="content-card active" id="countries">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-globe"></i> 国家管理</h3>
                <button class="btn btn-primary" onclick="showAddCountryModal()">
                    <i class="fas fa-plus"></i> 添加国家
                </button>
            </div>
            
            <div class="batch-actions">
                <button class="btn btn-danger" onclick="batchDelete('countries')">
                    <i class="fas fa-trash"></i> 批量删除选中国家
                </button>
                <span id="selectedCount">已选择 0 个国家</span>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="selectAllCountries" onchange="toggleSelectAll('countries')"></th>
                        <th>国家名称</th>
                        <th>国旗</th>
                        <th>代码</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="countriesTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 服务设置 -->
        <div class="content-card" id="services">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-mobile-alt"></i> 服务管理</h3>
                <button class="btn btn-primary" onclick="showAddServiceModal()">
                    <i class="fas fa-plus"></i> 添加服务
                </button>
            </div>
            
            <div class="batch-actions">
                <button class="btn btn-danger" onclick="batchDelete('services')">
                    <i class="fas fa-trash"></i> 批量删除选中服务
                </button>
                <span id="selectedServicesCount">已选择 0 个服务</span>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="selectAllServices" onchange="toggleSelectAll('services')"></th>
                        <th>服务名称</th>
                        <th>图标</th>
                        <th>代码</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="servicesTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>

        <!-- 价格设置 -->
        <div class="content-card" id="pricing">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3><i class="fas fa-tags"></i> 价格设置</h3>
                <button class="btn btn-primary" onclick="showAddPriceModal()">
                    <i class="fas fa-plus"></i> 添加价格规则
                </button>
            </div>
            
            <div class="search-controls" style="display: flex; gap: 15px; margin-bottom: 20px;">
                <div class="form-group" style="flex: 1;">
                    <label>筛选服务</label>
                    <select class="form-control" id="filterService" onchange="filterPricingTable()">
                        <option value="">所有服务</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>筛选国家</label>
                    <select class="form-control" id="filterCountry" onchange="filterPricingTable()">
                        <option value="">所有国家</option>
                    </select>
                </div>
            </div>
            
            <div class="batch-actions">
                <button class="btn btn-danger" onclick="batchDelete('pricing')">
                    <i class="fas fa-trash"></i> 批量删除选中价格规则
                </button>
                <span id="selectedPricingCount">已选择 0 个价格规则</span>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="selectAllPricing" onchange="toggleSelectAll('pricing')"></th>
                        <th>服务</th>
                        <th>国家</th>
                        <th>价格 ($)</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="pricingTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>
        
        <!-- 其他内容保持不变 -->
        <div class="content-card" id="users">
            <h3><i class="fas fa-users"></i> 用户管理</h3>
            <table>
                <thead>
                    <tr>
                        <th>用户ID</th>
                        <th>邮箱</th>
                        <th>API Key</th>
                        <th>余额</th>
                        <th>注册时间</th>
                        <th>最后登录</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="usersTable">
                    <!-- 动态加载 -->
                </tbody>
            </table>
        </div>

        <div class="content-card" id="crypto">
            <h3><i class="fas fa-exchange-alt"></i> 加密货币转账</h3>
            
            <div class="form-group">
                <label>选择用户</label>
                <select class="form-control" id="transferUser" onchange="loadUserCryptoInfo()">
                    <option value="">选择用户...</option>
                </select>
            </div>
            
            <!-- 用户加密货币信息 -->
            <div id="userCryptoInfo" style="display: none;">
                <!-- 内容保持不变 -->
            </div>
        </div>

        <div class="content-card" id="wallet">
            <h3><i class="fas fa-wallet"></i> 支付方式配置</h3>
            <!-- 内容保持不变 -->
        </div>
    </div>

    <!-- 添加国家模态框 -->
    <div class="modal" id="addCountryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加国家</h3>
                <button class="close-modal" onclick="closeModal('addCountryModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addCountryForm">
                    <div class="form-group">
                        <label>国家名称</label>
                        <input type="text" class="form-control" id="countryName" required>
                    </div>
                    <div class="form-group">
                        <label>国家代码</label>
                        <input type="text" class="form-control" id="countryCode" required placeholder="例如: CN, US">
                    </div>
                    <div class="form-group">
                        <label>国旗URL</label>
                        <input type="text" class="form-control" id="countryFlag" placeholder="输入国旗图片URL">
                        <small class="form-text text-muted">例如: https://flagcdn.com/w40/cn.png</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="text-align: right;">
                <button class="btn" onclick="closeModal('addCountryModal')">取消</button>
                <button class="btn btn-primary" onclick="addCountry()">添加</button>
            </div>
        </div>
    </div>

    <!-- 添加服务模态框 -->
    <div class="modal" id="addServiceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加服务</h3>
                <button class="close-modal" onclick="closeModal('addServiceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addServiceForm">
                    <div class="form-group">
                        <label>服务名称</label>
                        <input type="text" class="form-control" id="serviceName" required>
                    </div>
                    <div class="form-group">
                        <label>服务代码</label>
                        <input type="text" class="form-control" id="serviceCode" required placeholder="例如: whatsapp, telegram">
                    </div>
                    <div class="form-group">
                        <label>图标类名</label>
                        <input type="text" class="form-control" id="serviceIcon" placeholder="输入FontAwesome图标类名">
                        <small class="form-text text-muted">例如: fab fa-whatsapp</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="text-align: right;">
                <button class="btn" onclick="closeModal('addServiceModal')">取消</button>
                <button class="btn btn-primary" onclick="addService()">添加</button>
            </div>
        </div>
    </div>

    <!-- 添加价格规则模态框 -->
    <div class="modal" id="addPriceModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="priceModalTitle">添加价格规则</h3>
                <button class="close-modal" onclick="closeModal('addPriceModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addPriceForm">
                    <div class="form-group">
                        <label>选择服务</label>
                        <select class="form-control" id="priceService" required>
                            <option value="">选择服务...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>选择国家</label>
                        <select class="form-control" id="priceCountry" required>
                            <option value="">选择国家...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>价格 ($)</label>
                        <input type="number" class="form-control" id="priceAmount" step="0.01" min="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select class="form-control" id="priceStatus">
                            <option value="active">启用</option>
                            <option value="inactive">禁用</option>
                        </select>
                    </div>
                    <input type="hidden" id="priceModalAction" value="add">
                    <input type="hidden" id="priceRuleId" value="">
                </form>
            </div>
            <div class="modal-footer" style="text-align: right;">
                <button class="btn" onclick="closeModal('addPriceModal')">取消</button>
                <button class="btn btn-primary" onclick="savePriceRule()">保存价格规则</button>
            </div>
        </div>
    </div>

    <!-- 其他模态框保持不变 -->

    <script>
        // 检查管理员登录状态
        if (sessionStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'admin-login.html';
        }

        // 显示当前管理员
        const currentAdmin = sessionStorage.getItem('adminUsername') || '管理员';
        document.getElementById('currentAdmin').textContent = currentAdmin;
        document.getElementById('adminWelcome').textContent = currentAdmin;

        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyAKcWEdi_Zd-CAJYtEiwkbNNs7ibOp6HG4",
            authDomain: "sim-platform-fa8dd.firebaseapp.com",
            projectId: "sim-platform-fa8dd",
            storageBucket: "sim-platform-fa8dd.firebasestorage.app",
            messagingSenderId: "276606433877",
            appId: "1:276606433877:web:ac217c829ffdc735fff2dc"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

       // 数据存储
let appData = {
    countries: [],
    services: [],
    pricingRules: [],
    paymentMethods: [],
    users: []
};

     function initData() {
    const savedData = localStorage.getItem('appData');
    if (savedData) {
        try {
            appData = JSON.parse(savedData);
            console.log('成功加载数据:', appData);
        } catch (error) {
            console.error('解析数据失败:', error);
            initDefaultData();
        }
    } else {
        initDefaultData();
    }
}

function initDefaultData() {
    appData = {
        countries: [
            { id: 1, name: "中国", code: "CN", flag: "https://flagcdn.com/w40/cn.png", active: true },
            { id: 2, name: "美国", code: "US", flag: "https://flagcdn.com/w40/us.png", active: true },
            { id: 3, name: "英国", code: "GB", flag: "https://flagcdn.com/w40/gb.png", active: true }
        ],
        services: [
            { id: 1, name: "WhatsApp", code: "whatsapp", icon: "fab fa-whatsapp", active: true },
            { id: 2, name: "Telegram", code: "telegram", icon: "fab fa-telegram", active: true },
            { id: 3, name: "微信", code: "wechat", icon: "fab fa-weixin", active: true }
        ],
        pricingRules: [],
        paymentMethods: [],
        users: []
    };
    saveAppData();
}
        // 在 admin.html 的 saveAppData 函数中增强
function saveAppData() {
    localStorage.setItem('appData', JSON.stringify(appData));
    
    // 单独保存价格规则，方便 dashboard 读取
    localStorage.setItem('pricingRules', JSON.stringify(appData.pricingRules));
    
    // 通知所有打开的 dashboard 页面更新数据
    notifyDashboardUpdate();
}

// 增强通知机制
function notifyDashboardUpdate() {
    // 触发自定义事件
    const event = new Event('appDataUpdated');
    window.dispatchEvent(event);
    
    // 如果是 iframe 方式，通知父窗口
    if (window.parent && window.parent !== window) {
        window.parent.postMessage({ type: 'appDataUpdated' }, '*');
    }
    
    // 如果是多标签页，使用 localStorage 事件
    localStorage.setItem('lastUpdate', Date.now().toString());
}

// 监听其他页面的数据更新
window.addEventListener('storage', function(e) {
    if (e.key === 'lastUpdate') {
        initData();
        loadTabData(getCurrentTab());
    }
});

function getCurrentTab() {
    const activeTab = document.querySelector('.nav-item.active');
    return activeTab ? activeTab.dataset.tab : 'countries';
}
      
        // 退出登录
        function adminLogout() {
            sessionStorage.clear();
            window.location.href = 'admin-login.html';
        }

        // 更新时间
        function updateTime() {
            document.getElementById('currentTime').textContent = new Date().toLocaleString('zh-CN');
        }
        setInterval(updateTime, 1000);
        updateTime();

        // 侧边栏切换
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                if (this.dataset.tab) {
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll('.content-card').forEach(card => card.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                    document.getElementById('pageTitle').textContent = this.textContent.trim();
                    
                    loadTabData(this.dataset.tab);
                }
            });
        });

        // 加载标签页数据
        function loadTabData(tab) {
            switch(tab) {
                case 'countries':
                    loadCountriesTable();
                    break;
                case 'services':
                    loadServicesTable();
                    break;
                case 'pricing':
                    loadPricingPage();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'crypto':
                    loadTransferUsers();
                    break;
                case 'wallet':
                    loadWalletConfig();
                    break;
            }
            updateStats();
        }

       // 加载国家表格 - 修复版本
function loadCountriesTable() {
    const tbody = document.getElementById('countriesTable');
    tbody.innerHTML = '';
    
    console.log('加载国家数据:', appData.countries);
    
    if (appData.countries.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 20px; color: #6c757d;">
                    暂无国家数据，请点击"添加国家"按钮创建
                </td>
            </tr>
        `;
        return;
    }
    
    appData.countries.forEach(country => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="checkbox" name="countryCheckbox" value="${country.id}" onchange="updateSelectedCount('countries')"></td>
            <td>${country.name}</td>
            <td><img src="${country.flag}" alt="${country.name}" style="width: 24px; height: 16px; border-radius: 2px;"></td>
            <td>${country.code}</td>
            <td>
                <span class="badge ${country.active ? 'badge-success' : 'badge-secondary'}">
                    ${country.active ? '启用' : '禁用'}
                </span>
            </td>
            <td class="action-buttons">
                <button class="btn btn-sm btn-primary" onclick="toggleCountryStatus(${country.id})">
                    ${country.active ? '禁用' : '启用'}
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteCountry(${country.id})">删除</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateSelectedCount('countries');
}

        // 加载服务表格
        function loadServicesTable() {
            const tbody = document.getElementById('servicesTable');
            tbody.innerHTML = '';
            
            appData.services.forEach(service => {
                tbody.innerHTML += `
                    <tr>
                        <td><input type="checkbox" name="serviceCheckbox" value="${service.id}" onchange="updateSelectedCount('services')"></td>
                        <td>${service.name}</td>
                        <td><i class="${service.icon}" style="font-size: 1.2rem;"></i></td>
                        <td>${service.code}</td>
                        <td>${service.active ? '启用' : '禁用'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="toggleServiceStatus(${service.id})">${service.active ? '禁用' : '启用'}</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteService(${service.id})">删除</button>
                        </td>
                    </tr>
                `;
            });
            
            updateSelectedCount('services');
        }

        // 价格管理功能
        function loadPricingPage() {
            loadServicesForPricing();
            loadCountriesForPricing();
            loadPricingTable();
        }

        function loadServicesForPricing() {
            const serviceSelect = document.getElementById('priceService');
            const filterService = document.getElementById('filterService');
            
            serviceSelect.innerHTML = '<option value="">选择服务...</option>';
            filterService.innerHTML = '<option value="">所有服务</option>';
            
            appData.services.filter(service => service.active).forEach(service => {
                serviceSelect.innerHTML += `<option value="${service.id}">${service.name}</option>`;
                filterService.innerHTML += `<option value="${service.id}">${service.name}</option>`;
            });
        }

        function loadCountriesForPricing() {
            const countrySelect = document.getElementById('priceCountry');
            const filterCountry = document.getElementById('filterCountry');
            
            countrySelect.innerHTML = '<option value="">选择国家...</option>';
            filterCountry.innerHTML = '<option value="">所有国家</option>';
            
            appData.countries.filter(country => country.active).forEach(country => {
                countrySelect.innerHTML += `<option value="${country.id}">${country.name}</option>`;
                filterCountry.innerHTML += `<option value="${country.id}">${country.name}</option>`;
            });
        }

        function loadPricingTable() {
            const tbody = document.getElementById('pricingTable');
            tbody.innerHTML = '';
            
            const filterService = document.getElementById('filterService').value;
            const filterCountry = document.getElementById('filterCountry').value;
            
            let filteredRules = appData.pricingRules;
            
            if (filterService) {
                filteredRules = filteredRules.filter(rule => rule.serviceId == filterService);
            }
            
            if (filterCountry) {
                filteredRules = filteredRules.filter(rule => rule.countryId == filterCountry);
            }
            
            filteredRules.forEach(rule => {
                const service = appData.services.find(s => s.id == rule.serviceId);
                const country = appData.countries.find(c => c.id == rule.countryId);
                
                if (service && country) {
                    tbody.innerHTML += `
                        <tr>
                            <td><input type="checkbox" name="pricingCheckbox" value="${rule.id}" onchange="updateSelectedCount('pricing')"></td>
                            <td>${service.name}</td>
                            <td>${country.name}</td>
                            <td>$${rule.price.toFixed(2)}</td>
                            <td>${rule.active ? '启用' : '禁用'}</td>
                            <td>${new Date(rule.createdAt).toLocaleDateString()}</td>
                            <td class="action-buttons">
                                <button class="btn btn-sm btn-primary" onclick="editPriceRule(${rule.id})">编辑</button>
                                <button class="btn btn-sm btn-danger" onclick="deletePriceRule(${rule.id})">删除</button>
                            </td>
                        </tr>
                    `;
                }
            });
            
            updateSelectedCount('pricing');
            
            if (filteredRules.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 20px; color: #6c757d;">
                            暂无价格规则，请点击"添加价格规则"按钮创建
                        </td>
                    </tr>
                `;
            }
        }

                // 批量删除功能 - 修复版本
        function batchDelete(type) {
            let checkboxes, idsToDelete, confirmMessage, successMessage;
            
            switch(type) {
                case 'countries':
                    checkboxes = document.querySelectorAll('input[name="countryCheckbox"]:checked');
                    idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    confirmMessage = `确定要删除选中的 ${idsToDelete.length} 个国家吗？`;
                    successMessage = `成功删除 ${idsToDelete.length} 个国家！`;
                    break;
                case 'services':
                    checkboxes = document.querySelectorAll('input[name="serviceCheckbox"]:checked');
                    idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    confirmMessage = `确定要删除选中的 ${idsToDelete.length} 个服务吗？`;
                    successMessage = `成功删除 ${idsToDelete.length} 个服务！`;
                    break;
                case 'pricing':
                    checkboxes = document.querySelectorAll('input[name="pricingCheckbox"]:checked');
                    idsToDelete = Array.from(checkboxes).map(cb => parseInt(cb.value));
                    confirmMessage = `确定要删除选中的 ${idsToDelete.length} 个价格规则吗？`;
                    successMessage = `成功删除 ${idsToDelete.length} 个价格规则！`;
                    break;
                default:
                    console.error('未知的类型:', type);
                    return;
            }
            
            if (idsToDelete.length === 0) {
                alert('请先选择要删除的项');
                return;
            }
            
            if (confirm(confirmMessage)) {
                let hasChanges = false;
                
                switch(type) {
                    case 'countries':
                        const beforeCount = appData.countries.length;
                        appData.countries = appData.countries.filter(country => !idsToDelete.includes(country.id));
                        // 删除相关的价格规则
                        appData.pricingRules = appData.pricingRules.filter(rule => !idsToDelete.includes(rule.countryId));
                        hasChanges = beforeCount !== appData.countries.length;
                        if (hasChanges) loadCountriesTable();
                        break;
                        
                    case 'services':
                        const beforeServiceCount = appData.services.length;
                        appData.services = appData.services.filter(service => !idsToDelete.includes(service.id));
                        // 删除相关的价格规则
                        appData.pricingRules = appData.pricingRules.filter(rule => !idsToDelete.includes(rule.serviceId));
                        hasChanges = beforeServiceCount !== appData.services.length;
                        if (hasChanges) loadServicesTable();
                        break;
                        
                    case 'pricing':
                        const beforePricingCount = appData.pricingRules.length;
                        appData.pricingRules = appData.pricingRules.filter(rule => !idsToDelete.includes(rule.id));
                        hasChanges = beforePricingCount !== appData.pricingRules.length;
                        if (hasChanges) loadPricingTable();
                        break;
                }
                
                if (hasChanges) {
                    saveAppData();
                    alert(successMessage);
                    
                    // 重置全选复选框
                    const selectAllId = `selectAll${type.charAt(0).toUpperCase() + type.slice(1)}`;
                    const selectAllCheckbox = document.getElementById(selectAllId);
                    if (selectAllCheckbox) {
                        selectAllCheckbox.checked = false;
                    }
                    updateSelectedCount(type);
                }
            }
        }
        // 全选/取消全选
        function toggleSelectAll(type) {
            let selectAll, checkboxes;
            
            switch(type) {
                case 'countries':
                    selectAll = document.getElementById('selectAllCountries');
                    checkboxes = document.querySelectorAll('input[name="countryCheckbox"]');
                    break;
                case 'services':
                    selectAll = document.getElementById('selectAllServices');
                    checkboxes = document.querySelectorAll('input[name="serviceCheckbox"]');
                    break;
                case 'pricing':
                    selectAll = document.getElementById('selectAllPricing');
                    checkboxes = document.querySelectorAll('input[name="pricingCheckbox"]');
                    break;
                default:
                    return;
            }
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedCount(type);
        }

        // 更新选中数量
        function updateSelectedCount(type) {
            let checkboxes, countElement;
            
            switch(type) {
                case 'countries':
                    checkboxes = document.querySelectorAll('input[name="countryCheckbox"]:checked');
                    countElement = document.getElementById('selectedCount');
                    break;
                case 'services':
                    checkboxes = document.querySelectorAll('input[name="serviceCheckbox"]:checked');
                    countElement = document.getElementById('selectedServicesCount');
                    break;
                case 'pricing':
                    checkboxes = document.querySelectorAll('input[name="pricingCheckbox"]:checked');
                    countElement = document.getElementById('selectedPricingCount');
                    break;
                default:
                    return;
            }
            
            if (countElement) {
                countElement.textContent = `已选择 ${checkboxes.length} 个${type === 'countries' ? '国家' : type === 'services' ? '服务' : '价格规则'}`;
            }
        }

        // 国家管理功能
        function showAddCountryModal() {
            document.getElementById('addCountryForm').reset();
            document.getElementById('addCountryModal').style.display = 'flex';
        }

        function addCountry() {
            const name = document.getElementById('countryName').value;
            const code = document.getElementById('countryCode').value.toUpperCase();
            const flag = document.getElementById('countryFlag').value;
            
            if (!name || !code) {
                alert('请填写国家名称和代码');
                return;
            }
            
            // 检查是否已存在相同代码的国家
            const existingCountry = appData.countries.find(country => country.code === code);
            if (existingCountry) {
                alert('该国家代码已存在');
                return;
            }
            
            const newCountry = {
                id: Date.now(),
                name,
                code,
                flag: flag || `https://flagcdn.com/w40/${code.toLowerCase()}.png`,
                active: true
            };
            
            appData.countries.push(newCountry);
            saveAppData();
            loadCountriesTable();
            closeModal('addCountryModal');
            alert('国家添加成功！');
        }

        function toggleCountryStatus(countryId) {
            const country = appData.countries.find(c => c.id === countryId);
            if (country) {
                country.active = !country.active;
                saveAppData();
                loadCountriesTable();
            }
        }

        function deleteCountry(countryId) {
            if (confirm('确定要删除这个国家吗？相关的价格规则也会被删除！')) {
                appData.countries = appData.countries.filter(c => c.id !== countryId);
                // 删除相关的价格规则
                appData.pricingRules = appData.pricingRules.filter(rule => rule.countryId !== countryId);
                saveAppData();
                loadCountriesTable();
                alert('国家删除成功！');
            }
        }

        // 服务管理功能
        function showAddServiceModal() {
            document.getElementById('addServiceForm').reset();
            document.getElementById('addServiceModal').style.display = 'flex';
        }

        function addService() {
            const name = document.getElementById('serviceName').value;
            const code = document.getElementById('serviceCode').value.toLowerCase();
            const icon = document.getElementById('serviceIcon').value;
            
            if (!name || !code) {
                alert('请填写服务名称和代码');
                return;
            }
            
            // 检查是否已存在相同代码的服务
            const existingService = appData.services.find(service => service.code === code);
            if (existingService) {
                alert('该服务代码已存在');
                return;
            }
            
            const newService = {
                id: Date.now(),
                name,
                code,
                icon: icon || 'fas fa-mobile-alt',
                active: true
            };
            
            appData.services.push(newService);
            saveAppData();
            loadServicesTable();
            closeModal('addServiceModal');
            alert('服务添加成功！');
        }

        function toggleServiceStatus(serviceId) {
            const service = appData.services.find(s => s.id === serviceId);
            if (service) {
                service.active = !service.active;
                saveAppData();
                loadServicesTable();
            }
        }

        function deleteService(serviceId) {
            if (confirm('确定要删除这个服务吗？相关的价格规则也会被删除！')) {
                appData.services = appData.services.filter(s => s.id !== serviceId);
                // 删除相关的价格规则
                appData.pricingRules = appData.pricingRules.filter(rule => rule.serviceId !== serviceId);
                saveAppData();
                loadServicesTable();
                alert('服务删除成功！');
            }
        }

        // 价格规则功能
        function showAddPriceModal() {
            document.getElementById('priceModalTitle').textContent = '添加价格规则';
            document.getElementById('addPriceForm').reset();
            document.getElementById('priceModalAction').value = 'add';
            document.getElementById('priceRuleId').value = '';
            document.getElementById('addPriceModal').style.display = 'flex';
        }

        function savePriceRule() {
            const serviceId = parseInt(document.getElementById('priceService').value);
            const countryId = parseInt(document.getElementById('priceCountry').value);
            const price = parseFloat(document.getElementById('priceAmount').value);
            const active = document.getElementById('priceStatus').value === 'active';
            const action = document.getElementById('priceModalAction').value;
            const ruleId = document.getElementById('priceRuleId').value;
            
            if (!serviceId || !countryId || !price) {
                alert('请填写完整信息');
                return;
            }
            
            // 检查是否已存在相同的服务-国家组合
            const existingRule = appData.pricingRules.find(rule => 
                rule.serviceId === serviceId && rule.countryId === countryId && rule.id != ruleId
            );
            
            if (existingRule) {
                alert('该服务-国家组合的价格规则已存在，请编辑现有规则');
                return;
            }
            
            if (action === 'add') {
                const newRule = {
                    id: Date.now(),
                    serviceId,
                    countryId,
                    price,
                    active,
                    createdAt: new Date().toISOString()
                };
                appData.pricingRules.push(newRule);
            } else {
                const ruleIndex = appData.pricingRules.findIndex(rule => rule.id == ruleId);
                if (ruleIndex !== -1) {
                    appData.pricingRules[ruleIndex] = {
                        ...appData.pricingRules[ruleIndex],
                        serviceId,
                        countryId,
                        price,
                        active
                    };
                }
            }
            
            saveAppData();
            loadPricingTable();
            closeModal('addPriceModal');
            alert('价格规则保存成功！');
        }

        function editPriceRule(ruleId) {
            const rule = appData.pricingRules.find(r => r.id == ruleId);
            if (rule) {
                document.getElementById('priceModalTitle').textContent = '编辑价格规则';
                document.getElementById('priceService').value = rule.serviceId;
                document.getElementById('priceCountry').value = rule.countryId;
                document.getElementById('priceAmount').value = rule.price;
                document.getElementById('priceStatus').value = rule.active ? 'active' : 'inactive';
                document.getElementById('priceModalAction').value = 'edit';
                document.getElementById('priceRuleId').value = rule.id;
                document.getElementById('addPriceModal').style.display = 'flex';
            }
        }

        function deletePriceRule(ruleId) {
            if (confirm('确定要删除这个价格规则吗？')) {
                appData.pricingRules = appData.pricingRules.filter(rule => rule.id != ruleId);
                saveAppData();
                loadPricingTable();
                alert('价格规则已删除！');
            }
        }

        function filterPricingTable() {
            loadPricingTable();
        }

        // 模态框功能
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // 其他功能保持不变（用户管理、钱包设置等）
        async function loadUsers() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                const user = doc.data();
                const apiKey = user.apiKey || '未生成';
                const shortApiKey = apiKey.length > 20 ? apiKey.substring(0, 20) + '...' : apiKey;
                
                tbody.innerHTML += `
                    <tr>
                        <td>${doc.id.substring(0, 8)}...</td>
                        <td>${user.email}</td>
                        <td title="${apiKey}">${shortApiKey}</td>
                        <td>¥${user.balance || 0}</td>
                        <td>${user.createdAt?.toDate?.().toLocaleDateString() || '未知'}</td>
                        <td>${user.lastLogin?.toDate?.().toLocaleDateString() || '未知'}</td>
                        <td class="action-buttons">
                            <button class="btn btn-sm btn-primary" onclick="showUserDetail('${doc.id}')">详情</button>
                            <button class="btn btn-sm btn-warning" onclick="editUserBalance('${doc.id}')">调整余额</button>
                        </td>
                    </tr>
                `;
            });
        }

        function loadWalletConfig() {
            // 钱包配置加载逻辑
        }

        async function loadTransferUsers() {
            const select = document.getElementById('transferUser');
            select.innerHTML = '<option value="">选择用户...</option>';
            
            const snapshot = await db.collection('users').get();
            snapshot.forEach(doc => {
                const user = doc.data();
                select.innerHTML += `<option value="${doc.id}">${user.email} (余额: ¥${user.balance || 0})</option>`;
            });
        }

        function updateStats() {
            document.getElementById('totalServices').textContent = appData.services.length;
            document.getElementById('activeServices').textContent = appData.services.filter(s => s.active).length;
            
            db.collection('users').get().then(snapshot => {
                document.getElementById('totalUsers').textContent = snapshot.size;
            });
        }

      // 初始化 - 使用DOMContentLoaded确保页面加载完成
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin页面加载完成，开始初始化数据...');
    initData();
    loadTabData('countries');
    
    // 调试：检查数据是否加载成功
    setTimeout(() => {
        console.log('当前appData:', appData);
        console.log('国家数量:', appData.countries.length);
        console.log('服务数量:', appData.services.length);
        console.log('价格规则数量:', appData.pricingRules.length);
    }, 1000);
});
    </script>
</body>
</html>
